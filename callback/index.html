<!DOCTYPE html>
<html>
<head>
  <title>OAuth Callback</title>
  <meta charset="utf-8">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    pre {
      text-align: left;
      background: #f5f5f5;
      padding: 10px;
      font-size: 11px;
      overflow: auto;
      max-height: 200px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîê Processing Authentication</h2>
    <div class="spinner"></div>
    <p id="status">Exchanging authorization code...</p>
    <pre id="debug" style="display:none;"></pre>
  </div>
  
  <script>
    (function() {
      'use strict';
      
      const debugEl = document.getElementById('debug');
      const statusEl = document.getElementById('status');
      
      function log(msg) {
        console.log(msg);
        if (debugEl) {
          debugEl.style.display = 'block';
          debugEl.textContent += msg + '\n';
        }
      }
      
      function updateStatus(msg, isError) {
        if (statusEl) {
          statusEl.textContent = msg;
          if (isError) statusEl.style.color = 'red';
        }
      }
      
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      
      log('=== CALLBACK START ===');
      log('Code: ' + (code ? 'YES' : 'NO'));
      log('Opener: ' + (window.opener ? 'YES' : 'NO'));
      log('Origin: ' + window.location.origin);
      
      if (!code) {
        log('ERROR: No code');
        updateStatus('Error: No authorization code', true);
        return;
      }
      
      if (!window.opener) {
        log('ERROR: No opener');
        updateStatus('Error: No parent window', true);
        return;
      }
      
      // Exchange code for token
      const lambdaUrl = 'https://1aqk2aes0f.execute-api.eu-west-2.amazonaws.com/callback';
      const url = lambdaUrl + '?code=' + encodeURIComponent(code) + '&state=' + encodeURIComponent(state || '');
      
      log('Fetching: ' + lambdaUrl);
      updateStatus('Contacting server...');
      
      fetch(url)
        .then(function(response) {
          log('Response status: ' + response.status);
          return response.json();
        })
        .then(function(data) {
          log('Data received: ' + JSON.stringify(data));
          
          if (!data.access_token) {
            log('ERROR: No token in response');
            updateStatus('Error: No access token', true);
            return;
          }
          
          updateStatus('Sending token to CMS...');
          
          const token = data.access_token;
          log('Token: ' + token.substring(0, 10) + '...');
          
          // THIS IS THE KEY: Send the message in the EXACT format Decap expects
          // Based on decap-cms-core source code
          const message = 'authorization:github:success:' + JSON.stringify({
            token: token,
            provider: 'github'
          });
          
          log('Message: ' + message.substring(0, 50) + '...');
          log('Sending to: ' + window.location.origin);
          
          // Send message
          window.opener.postMessage(message, window.location.origin);
          log('‚úì Message sent');
          
          updateStatus('Success! Closing...');
          
          // Don't close immediately - give more time for message to be processed
          setTimeout(function() {
            log('Attempting to close...');
            window.close();
            
            // If window doesn't close, show message
            setTimeout(function() {
              updateStatus('Done! You can close this window.');
              debugEl.style.display = 'block';
            }, 1000);
          }, 2000); // Wait 2 seconds before closing
          
        })
        .catch(function(err) {
          log('ERROR: ' + err.message);
          updateStatus('Error: ' + err.message, true);
        });
      
    })();
  </script>
</body>
</html>
